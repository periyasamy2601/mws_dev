pipeline {
    agent any

    environment {
        FLUTTER_HOME = "/opt/flutter"
        PATH = "${env.FLUTTER_HOME}/bin:/usr/local/bin:${env.PATH}"
        ANDROID_APP_ID = "1:796222979324:android:9f889d354edb178c1aeb79"
        IOS_APP_ID = "1:796222979324:ios:8f12cbf67ef2727a1aeb79"
        SONAR_PROJECT_KEY = "mws_frontend"
        SONAR_PROJECT_NAME = "mws_frontend"
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/periyasamy2601/mws_dev.git',
                    credentialsId: 'github_token_dev'
            }
        }

        stage('Install Dependencies') {
            steps {
                dir('avk-frontend') {
                    sh 'flutter clean'
                    sh 'flutter pub get'

                    dir('ios') {
                        sh 'pod install || true'
                    }
                }
            }
        }

        stage('Versioning') {
            steps {
                dir('avk-frontend') {
                    script {
                        def versionFile = readFile('pubspec.yaml')
                        def versionLine = versionFile.readLines().find { it.startsWith('version:') }
                        def currentVersion = versionLine.split(':')[1].trim().split('\\+')[0]
                        def buildNumber = versionLine.split('\\+')[1].trim().toInteger() + 1
                        def newVersion = "${currentVersion}+${buildNumber}"
                        sh "sed -i 's/version:.*/version: ${newVersion}/' pubspec.yaml"
                        echo "Updated version to ${newVersion}"
                    }
                }
            }
        }

        // Android Build Stage
        stage('Build Android (Prod)') {
            steps {
                dir('avk-frontend') {
                    script {
                        echo 'Building Android APK (Prod)...'
                        sh 'flutter build apk --release --flavor prod -t lib/main_prod.dart'
                    }
                }
            }
        }

        // Web Build Stage
        stage('Build Web (Prod)') {
            steps {
                dir('avk-frontend') {
                    script {
                        echo 'Building Web App (Prod)...'
                        sh 'flutter build web --release -t lib/main_prod.dart'
                    }
                }
            }
        }

        // iOS Build Stage (macOS only)
        stage('Build iOS (Prod)') {
            when {
                expression { isUnix() }
            }
            steps {
                dir('avk-frontend') {
                    script {
                        echo 'Building iOS App (Prod)...'
                        sh 'flutter build ios --flavor prod -t lib/main_prod.dart'
                    }
                }
            }
        }

        // Deploy Web
        stage('Deploy Web') {
            steps {
                withCredentials([file(credentialsId: 'firebase_dev_json', variable: 'GOOGLE_APPLICATION_CREDENTIALS')]) {
                    sh 'firebase deploy --only hosting'
                }
            }
        }

        // Deploy Android
        stage('Deploy Android') {
            steps {
                dir('avk-frontend') {
                    withCredentials([string(credentialsId: 'firebase_token', variable: 'FIREBASE_TOKEN')]) {
                        sh """
                        firebase appdistribution:distribute build/app/outputs/flutter-apk/app-release.apk \
                          --app $ANDROID_APP_ID \
                          --groups "dev-testers" \
                          --release-notes "Dev build ${BUILD_NUMBER}" \
                          --token $FIREBASE_TOKEN
                        """
                    }
                }
            }
        }

        // Deploy iOS
        stage('Deploy iOS') {
            steps {
                dir('avk-frontend') {
                    withCredentials([string(credentialsId: 'firebase_token', variable: 'FIREBASE_TOKEN')]) {
                        sh """
                        firebase appdistribution:distribute build/ios/ipa/Runner.ipa \
                          --app $IOS_APP_ID \
                          --groups "dev-testers" \
                          --release-notes "Dev build ${BUILD_NUMBER}" \
                          --token $FIREBASE_TOKEN
                        """
                    }
                }
            }
        }
    }

    post {
        success { echo 'Dev frontend pipeline completed successfully!' }
        failure { echo 'Pipeline failed! Check logs.' }
    }
}
