pipeline {
  agent none

  options {
    skipDefaultCheckout(true)
  }

  environment {
    DOCKER_IMAGE       = "mwsdev2025/mws_avk_api"
    SONAR_HOST         = "http://192.168.2.20:9000"
    SONAR_PROJECT_KEY  = "mws_avk_api"
    SONAR_PROJECT_NAME = "mws_avk_api"
    DB_HOST            = "192.168.2.20"
    DB_PORT            = "5432"
    DB_NAME            = "mws_avk_api"
  }

  stages {
    stage('Checkout') {
      agent { label 'build-node' }
      steps {
        deleteDir()
        git branch: 'main', credentialsId: 'github_token_dev', url: 'https://github.com/periyasamy2601/mws_dev.git'
      }
    }

    stage('Install Dependencies') {
      agent { label 'build-node' }
      steps {
        sh 'npm install'
      }
    }

    stage('ESLint') {
      agent { label 'build-node' }
      steps {
        sh 'npx eslint . -f json -o eslint-report.json || true'
      }
    }

    stage('SonarQube Scan') {
      agent { label 'build-node' }
      steps {
        withSonarQubeEnv('sonar scanner') {
          script {
            def scannerHome = tool 'sonar scanner'
            sh """
              ${scannerHome}/bin/sonar-scanner \
                -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                -Dsonar.projectName=${SONAR_PROJECT_NAME} \
                -Dsonar.sources=. \
                -Dsonar.host.url=${SONAR_HOST} \
                -Dsonar.eslint.reportPaths=eslint-report.json \
                -Dsonar.scanner.workDirectory=/tmp/.sonar
            """
          }
        }
      }
    }
  }
}
