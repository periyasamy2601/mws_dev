pipeline {
  agent none

  environment {
    DOCKER_IMAGE       = "mwsdev2025/mws_avk_api"
    SONAR_HOST         = "http://192.168.2.20:9000"
    SONAR_PROJECT_KEY  = "mws_avk_api"
    SONAR_PROJECT_NAME = "mws_avk_api"
    DB_HOST            = "192.168.2.20"
    DB_PORT            = "5432"
    DB_NAME            = "mws_avk_api"
  }

  stages {
    stage('Checkout') {
      agent { label 'build-node' }
      steps {
        deleteDir()   // Clean workspace to avoid old permission issues
        git branch: 'main', url: 'https://github.com/periyasamy2601/mws_dev.git'
      }
    }

    stage('Install Dependencies') {
      agent { label 'build-node' }
      steps {
        sh 'npm install'
      }
    }

    stage('ESLint') {
      agent { label 'build-node' }
      steps {
        // Run eslint and save report in JSON for SonarQube
        sh 'npx eslint . -f json -o eslint-report.json || true'
      }
    }

    stage('SonarQube Scan') {
      agent { label 'build-node' }
      steps {
        withSonarQubeEnv('sonar scanner') {   // must match SonarQube server config in Jenkins
          script {
            def scannerHome = tool 'sonar scanner'   // must match tool name in Global Tool Configuration
            sh """
              ${scannerHome}/bin/sonar-scanner \
                -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                -Dsonar.projectName=${SONAR_PROJECT_NAME} \
                -Dsonar.sources=. \
                -Dsonar.host.url=${SONAR_HOST} \
                -Dsonar.scanner.workDirectory=/tmp/.sonar \
                -Dsonar.eslint.reportPaths=eslint-report.json
            """
          }
        }
      }
    }
  }
}

