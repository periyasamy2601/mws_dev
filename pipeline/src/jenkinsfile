pipeline {
  agent none

  environment {
    DOCKER_IMAGE       = "mwsdev2025/mws_avk_api"
    SONAR_HOST         = "http://192.168.2.20:9000"
    SONAR_PROJECT_KEY  = "mws_avk_api"
    SONAR_PROJECT_NAME = "mws_avk_api"
    DB_HOST            = "192.168.2.20"
    DB_PORT            = "5432"
    DB_NAME            = "mws_avk_api"
  }

  stages {
    stage('Checkout') {
      agent { label 'build-node' }
      steps {
        deleteDir()             // Clean workspace
        checkout scm            // Checkout full repository
        sh 'ls -la'             // Verify package.json exists
      }
    }

    stage('Install Dependencies') {
      agent { label 'build-node' }
      steps {
        script {
          if (fileExists('node_modules')) {
            echo "Using cached node_modules"
          } else {
            echo "Installing npm dependencies..."
            sh 'npm install'
          }
        }
      }
    }

    stage('ESLint') {
      agent { label 'build-node' }
      steps {
        // Run ESLint and generate JSON report
        sh 'npx eslint . -f json -o eslint-report.json || true'
      }
    }

    stage('SonarQube Scan') {
      agent { label 'build-node' }
      steps {
        withSonarQubeEnv('sonar scanner') {   // Match Jenkins SonarQube server
          script {
            def scannerHome = tool 'sonar scanner'   // Match tool name in Jenkins
            sh """
              ${scannerHome}/bin/sonar-scanner \
                -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                -Dsonar.projectName=${SONAR_PROJECT_NAME} \
                -Dsonar.sources=. \
                -Dsonar.host.url=${SONAR_HOST} \
                -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info \
                -Dsonar.eslint.reportPaths=eslint-report.json \
                -Dsonar.scanner.workDirectory=/tmp/.sonar
            """
          }
        }
      }
    }
  }
}
