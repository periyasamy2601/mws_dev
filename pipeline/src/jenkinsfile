pipeline {
  agent none

  environment {
    DOCKER_IMAGE       = "mwsdev2025/mws_avk_api"
    DB_HOST            = "192.168.2.20"
    DB_PORT            = "5432"
    DB_NAME            = "mws_avk_api"
    NODE_ENV           = "development"
  }

  stages {
    stage('Checkout') {
      agent { label 'build-node' }
      steps {
        deleteDir()
        git branch: 'main', url: 'https://github.com/periyasamy2601/mws_dev.git', credentialsId: 'github_token_dev'
      }
    }

    stage('Install Dependencies') {
      agent { label 'build-node' }
      steps {
        sh 'npm install'
      }
    }

    stage('DB Migration') {
      agent { label 'build-node' }
      steps {
        script {
          if (env.NODE_ENV == "development") {
            sh 'npm run dev-migrate'
          } else if (env.NODE_ENV == "stage") {
            sh 'npm run stage-migrate'
          } else if (env.NODE_ENV == "production") {
            sh 'npm run prod-migrate'
          }
        }
      }
    }
  }

  post {
    always {
      cleanWs()   // clean Jenkins workspace after build
    }
  }
}
